<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - MealMemo</title>
    <link rel="stylesheet" href="/src/css/style.css" />
  </head>
  <body>
    <div id="header"></div>

    <main class="container">
      <div class="page-header">
        <h1>üîß Admin Dashboard</h1>
        <p class="subtitle">Manage users and their roles</p>
      </div>

      <div class="search-container">
        <form class="search-form" id="search-form">
          <input
            type="email"
            id="search-input"
            placeholder="Search by email..."
            class="search-input"
          />
          <button type="submit" class="btn btn-primary">Search</button>
          <button
            type="button"
            id="clear-search"
            class="btn btn-secondary"
            style="display: none"
          >
            Show All Users
          </button>
        </form>
      </div>

      <div id="users-container"></div>
    </main>

    <div id="footer"></div>

    <script type="module">
      import { loadHeader, loadFooter } from "/src/js/components.js";
      import { requireAdmin, getUser } from "/src/js/auth.js";
      import { admin } from "/src/js/api.js";
      import {
        showLoading,
        showError,
        showSuccess,
        formatDate,
      } from "/src/js/utils.js";

      requireAdmin();
      loadHeader();
      loadFooter();

      const container = document.getElementById("users-container");
      const searchInput = document.getElementById("search-input");
      const searchForm = document.getElementById("search-form");
      const clearBtn = document.getElementById("clear-search");
      const currentUser = getUser();

      let isSearching = false;

      async function loadAllUsers() {
        showLoading(container);
        isSearching = false;
        clearBtn.style.display = "none";
        searchInput.value = "";

        try {
          const data = await admin.getAllUsers();
          renderUsers(data.users);
        } catch (error) {
          showError(container, error.message || "Failed to load users");
        }
      }

      async function searchUser(email) {
        showLoading(container);
        isSearching = true;
        clearBtn.style.display = "inline-block";

        try {
          const data = await admin.searchUser(email);

          if (data.user) {
            renderUsers([data.user]);
          } else {
            container.innerHTML = `
                        <div class="empty-state">
                            <p>No user found with email: ${email}</p>
                            <button class="btn btn-primary" onclick="window.loadAllUsers()">Show All Users</button>
                        </div>
                    `;
          }
        } catch (error) {
          showError(container, error.message || "Failed to search user");
        }
      }

      function renderUsers(users) {
        if (!users || users.length === 0) {
          container.innerHTML = `
                    <div class="empty-state">
                        <p>No users found.</p>
                    </div>
                `;
          return;
        }

        container.innerHTML = `
                <div class="admin-stats">
                    <p><strong>Total Users:</strong> ${users.length}</p>
                    <p><strong>Admins:</strong> ${users.filter((u) => u.role === "admin").length}</p>
                    <p><strong>Contributors:</strong> ${users.filter((u) => u.role === "contributor").length}</p>
                    <p><strong>Users:</strong> ${users.filter((u) => u.role === "user").length}</p>
                </div>
                
                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>User ID</th>
                                <th>Email</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${users
                              .map(
                                (user) => `
                                <tr>
                                    <td>${user.user_id}</td>
                                    <td>${user.email}</td>
                                    <td>${user.first_name} ${user.last_name}</td>
                                    <td>
                                        <span class="role-badge role-${user.role}">${user.role.toUpperCase()}</span>
                                    </td>
                                    <td>${formatDate(user.created_at)}</td>
                                    <td>
                                        ${
                                          user.user_id === currentUser.user_id
                                            ? `
                                            <span class="text-muted">You</span>
                                        `
                                            : `
                                            <select 
                                                class="role-select" 
                                                data-user-id="${user.user_id}"
                                                data-current-role="${user.role}"
                                            >
                                                <option value="">Change Role...</option>
                                                <option value="user">User</option>
                                                <option value="contributor">Contributor</option>
                                                <option value="admin">Admin</option>
                                            </select>
                                        `
                                        }
                                    </td>
                                </tr>
                            `,
                              )
                              .join("")}
                        </tbody>
                    </table>
                </div>
                
                <div class="admin-notice">
                    <p><strong>‚ö†Ô∏è Important:</strong> Users must log out and log back in after role changes for the new permissions to take effect.</p>
                </div>
            `;

        const roleSelects = document.querySelectorAll(".role-select");
        roleSelects.forEach((select) => {
          select.addEventListener("change", handleRoleChange);
        });
      }

      async function handleRoleChange(event) {
        const select = event.target;
        const userId = parseInt(select.dataset.userId);
        const currentRole = select.dataset.currentRole;
        const newRole = select.value;

        if (!newRole) return;

        if (
          !confirm(
            `Change user's role from ${currentRole} to ${newRole}?\n\nNote: The user will need to log out and log back in for changes to take effect.`,
          )
        ) {
          select.value = "";
          return;
        }

        try {
          await admin.updateUserRole(userId, newRole);
          showSuccess(`User role updated to ${newRole} successfully!`);

          if (isSearching) {
            searchUser(searchInput.value);
          } else {
            loadAllUsers();
          }
        } catch (error) {
          alert(error.message || "Failed to update user role");
          select.value = "";
        }
      }

      searchForm.addEventListener("submit", (e) => {
        e.preventDefault();
        const email = searchInput.value.trim();

        if (!email) {
          alert("Please enter an email address");
          return;
        }

        searchUser(email);
      });

      clearBtn.addEventListener("click", loadAllUsers);

      window.loadAllUsers = loadAllUsers;

      loadAllUsers();
    </script>

    <style>
      .admin-stats {
        display: flex;
        gap: 2rem;
        flex-wrap: wrap;
        margin: 2rem 0;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .admin-stats p {
        margin: 0;
        font-size: 1.1rem;
      }

      .users-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
        margin: 2rem 0;
      }

      .users-table {
        width: 100%;
        border-collapse: collapse;
      }

      .users-table th,
      .users-table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #ecf0f1;
      }

      .users-table th {
        background-color: #2c3e50;
        color: white;
        font-weight: 600;
      }

      .users-table tbody tr:hover {
        background-color: #f8f9fa;
      }

      .role-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.875rem;
        font-weight: 600;
      }

      .role-admin {
        background-color: #e74c3c;
        color: white;
      }

      .role-contributor {
        background-color: #3498db;
        color: white;
      }

      .role-user {
        background-color: #95a5a6;
        color: white;
      }

      .role-select {
        padding: 0.5rem;
        border: 1px solid #ced4da;
        border-radius: 5px;
        font-size: 0.9rem;
        cursor: pointer;
      }

      .role-select:hover {
        border-color: #3498db;
      }

      .admin-notice {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 1.5rem;
        border-radius: 8px;
        margin: 2rem 0;
      }

      .admin-notice p {
        margin: 0;
      }

      @media (max-width: 768px) {
        .users-table {
          font-size: 0.875rem;
        }

        .users-table th,
        .users-table td {
          padding: 0.5rem;
        }

        .admin-stats {
          flex-direction: column;
          gap: 0.5rem;
        }
      }
    </style>
  </body>
</html>
